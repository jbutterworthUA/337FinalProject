<!--
    File: watchlist.html
    Desc: Will show a table of the user's watchlist.
    To get this, we need to scan their personal catalog json for any obj ? flagged===true.
    If so, display it in the table, with the option to mark as watched which will set flagged===false
    and remove it from the watchlist table and place it back in the catalog.html table.
-->
<!DOCTYPE html>
<html>
    <head>
        <title>Watchlist</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="menu-bar">
            <a href="./visualization.html">Visualization</a>
            <a href="./start.html">Log Out</a>
            <a href="./catalog.html">Back to Catalog</a>
            <a href="./ratings.html">Rated Movies</a>
        </div>

        <h1>Your Watchlist</h1>

        <table>
            <tr>
                <th>Title</th><th>Genre</th><th>Description</th><th>Remove</th>
            </tr>
            <tbody id="watchlistTable"></tbody>
        </table>

        <script>
            function fillWatchlist() {
                const currentUser = localStorage.getItem("currentUser");

                fetch(`/databases/user_catalogs/${currentUser}_catalog.json`)
                    .then(res => res.json())
                    .then(catalog => {
                        const table = document.getElementById("watchlistTable");

                        // Clear only the tbody rows (keep the headers)
                        table.innerHTML = "";

                        for (let movie of catalog) {
                            if (movie.flagged && movie.rating == 0) {
                                const row = document.createElement("tr");
                                
                                row.innerHTML = `
                                    <td>${movie.title}</td>
                                    <td>${movie.genre}</td>
                                    <td>${movie.description}</td>
                                    <td>
                                        <button onclick="removeFromWatchlist('${movie.title}')">
                                            Remove
                                        </button>
                                    </td>
                                `;

                                table.appendChild(row);
                            }
                        }
                    })
                    .catch(err => console.error("Error loading watchlist:", err));
            }

            function removeFromWatchlist(title) {
                const currentUser = localStorage.getItem("currentUser");

                let rating = prompt("Please give a rating for this movie (1-5):");
                rating = parseInt(rating);

                if (isNaN(rating) || rating < 1 || rating > 5) {
                    alert("Invalid rating! Please enter a number between 1 and 5.");
                    return;
                }

                fetch("/removeFromWatchlist", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ user: currentUser, title, rating })
                })
                .then(res => res.json())
                .then(data => {
                    console.log(data.message);
                    fillWatchlist(); // refresh table after movie was removed
                })
                .catch(err => console.error("Error removing from watchlist:", err));
            }

            fillWatchlist();
        </script>
    </body>
</html>
